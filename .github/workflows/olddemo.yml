
name: Python application

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    -  name: Set up Docker Buildx
       uses: docker/setup-buildx-action@v2
    -
        name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}
    - name: Build and push ${{ github.repository }}
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./HelloApp/Dockerfile
        push: true
        tags: ghcr.io/${{ github.repository }}:latest
      #  build-args: BASE_IMAGE=ghcr.io/${{ github.repository_owner }}/phelas-connectors:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
        needs: build
        name: deploy image
        runs-on: ubuntu-latest

        steps:
        - name: install ssh keys
          # check this thread to understand why its needed:
          # <https://stackoverflow.com/a/70447517>
          run: |
            install -m 600 -D /dev/null ~/.ssh/id_ed25519
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
            ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts
        - name: connect and pull
          run: ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ secrets.WORK_DIR }} && docker compose pull && docker compose up -d && exit"



# Next step: use this for CD with discoverer https://www.programonaut.com/how-to-deploy-a-docker-image-to-a-server-using-github-actions/



    #- name: Test with pytest
     # run: |
      #  pytest
